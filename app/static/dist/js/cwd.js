let controller=new AbortController();let signal=controller.signal;function getCsrfToken(){return document.querySelector('meta[name="csrf-token"]').getAttribute("content");}
document.addEventListener("DOMContentLoaded",function(){const queryInput=document.getElementById("query");queryInput.addEventListener("keydown",function(event){if(event.key==="Enter"){event.preventDefault();queryDocument();}});});let previousQuery=null;let previousResponse=null;function addToQueryHistory(query,response){const queryResultsSection=document.getElementById("query-results-section");const currentQueryResponse=document.getElementById("current-query");const historyEntry=document.createElement("div");historyEntry.className="history-entry";historyEntry.innerHTML=`<strong>Query:</strong><pre>${query}</pre><br><br><strong>Response:</strong><pre>${response}</pre><hr class="history-delimiter"><!--This is the delimiter-->`;queryResultsSection.insertBefore(historyEntry,currentQueryResponse);document.getElementById("user_query").textContent="";document.getElementById("results").textContent="";document.getElementById("user_query").parentNode.style.display="none";document.getElementById("response_container").style.display="none";}
async function queryDocument(){document.getElementById("interruptButton").disabled=false;const checkboxes=document.querySelectorAll('input[name="selected_docs"]:checked',);if(checkboxes.length===0){return;}
const query=document.getElementById("query").value.trim();if(query===""){showAlertInChatbox("Query cannot be empty.","warning");return;}
const userQueryElement=document.getElementById("user_query");userQueryElement.parentNode.style.display="block";userQueryElement.textContent=query;document.getElementById("query").value="";const resultsDiv=document.getElementById("results");resultsDiv.innerHTML="<pre></pre>";const preElement=resultsDiv.querySelector("pre");const selectedDocs=[];checkboxes.forEach((checkbox)=>{selectedDocs.push(checkbox.value);});previousQuery=query;previousResponse="";try{const response=await fetch("/cwd/query",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-CSRFToken":getCsrfToken(),},body:`query=${encodeURIComponent(query,)}&selected_docs=${encodeURIComponent(selectedDocs.join(","))}`,signal:signal,});if(response.ok){const reader=response.body.getReader();let decoder=new TextDecoder();const responseLabelContainer=document.getElementById("response_container");const resultsSpan=document.getElementById("results");responseLabelContainer.style.display="block";while(true){const{value,done}=await reader.read();if(done){break;}
resultsSpan.textContent+=decoder.decode(value);previousResponse+=decoder.decode(value);}
document.getElementById("results").textContent=previousResponse;addToQueryHistory(previousQuery,previousResponse);previousResponse="";}else{showAlertInChatbox("Error occurred while querying.","danger");}}catch(error){if(error.name==="AbortError"){showAlertInChatbox("Interrupted!","warning");}else{showAlertInChatbox("Error occurred while querying.","danger");}}}
function interruptQuery(){controller.abort();controller=new AbortController();signal=controller.signal;const resultsSpan=document.getElementById("results");if(resultsSpan.lastChild){resultsSpan.removeChild(resultsSpan.lastChild);}
document.getElementById("interruptButton").disabled=true;document.getElementById("queryButton").disabled=false;}
document.addEventListener("click",function(event){if(event.target.classList.contains("delete-btn")||event.target.closest(".delete-btn")){var deleteButton=event.target.classList.contains("delete-btn")?event.target:event.target.closest(".delete-btn");var documentId=deleteButton.dataset.docId;if(confirm("Are you sure you want to delete this document?")){fetch(`/embedding/delete/${documentId}`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-Token":getCsrfToken(),},body:JSON.stringify({document_id:documentId}),}).then((response)=>{if(!response.ok){throw new Error("Server returned an error response");}
return response.json();}).then((data)=>{if(data.error){alert("Error deleting document: "+data.error);}else{showAlert("Document deleted successfully!","success");const listItem=deleteButton.closest("li");if(listItem){listItem.remove();}}}).catch((error)=>{alert("An error occurred: "+error);showAlert("Error deleting document: "+error.message,"error");});}}});function showAlert(message,type,context="apiKey"){let alertsDiv;switch(context){case"upload":alertsDiv=document.querySelector(".uploadAlerts");break;case"query":alertsDiv=document.getElementById("queryAlertInsideInput");break;default:alertsDiv=document.querySelector(".apiKeyAlerts");}
if(context==="query"){alertsDiv.textContent=message;}else{}}
function showAlertInChatbox(message,type){const resultsSpan=document.getElementById("results");const responseLabel=document.getElementById("responseLabel");resultsSpan.textContent="";resultsSpan.innerHTML=`<div class='alert alert-${type}'>${message}</div>`;}